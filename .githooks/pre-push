#!/bin/bash
#
# Pre-push hook to prevent direct pushes to main/master branches.
# This enforces the fork workflow where changes go through PRs.
#
# To install: git config core.hooksPath .githooks
# Or copy to: .git/hooks/pre-push

remote="$1"
url="$2"

# Protected branches
protected_branches="main master"

# Read stdin for ref updates
while read local_ref local_sha remote_ref remote_sha
do
    # Extract branch name from remote ref
    branch=$(echo "$remote_ref" | sed 's|refs/heads/||')

    for protected in $protected_branches; do
        if [ "$branch" = "$protected" ]; then
            echo ""
            echo "=========================================="
            echo " PUSH BLOCKED: Protected branch detected"
            echo "=========================================="
            echo ""
            echo " You are trying to push to '$branch' on '$remote'."
            echo ""
            echo " This repository uses a fork workflow:"
            echo "   1. Create a feature branch"
            echo "   2. Push feature branch to origin (your fork)"
            echo "   3. Create a PR targeting upstream/main"
            echo ""
            echo " To push your changes:"
            echo "   git checkout -b feature/my-feature"
            echo "   git push origin feature/my-feature"
            echo ""
            echo " To bypass (not recommended):"
            echo "   git push --no-verify"
            echo ""
            exit 1
        fi
    done
done

exit 0
